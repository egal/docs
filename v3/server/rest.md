# REST

## Routing

>Для создания маршрутов до rest-endpoints определенной модели необходимо наличие класса [модели](/v3/server/models) и класса [политики](/v3/server/rest#Ограничение-доступа). 

Регистрация в файле маршрутов с помощью фасада Route выглядит следующим образом:

```php
<?php

use App\Http\Policies\PostPolicy;
use App\Models\Post;
use Egal\Core\Facades\Route as EgalRoute;


EgalRoute::rest(Post::class, PostPolicy::class);
```
Вызов `EgalRoute::rest(Post::class, PostPolicy::class)` создаст следующий набор маршрутов:

|  Метод   |    Адрес    | Endpoint | Назначение                  |
|:--------:|:-----------:|:--------:|:----------------------------|
| GET/HEAD |    posts    |  index   | Получить список всех постов |
|   POST   |    posts    |  create  | Создать пост                |
| GET/HEAD | posts/{key} |   show   | Получить пост по ключу      |
|  DELETE  | posts/{key} |  delete  | Удалить пост по ключу       |
|  PATCH   | posts/{key} |  update  | Редактировать пост по ключу |


## Ограничение доступа

С помощью класса политики возможно настраивать доступ как в целом до rest-endpoints, так и до отдельных объектов модели 
при вызове rest-endpoint. Создать политику можно с помощью вызова команды генерации политики с передачей названия модели, 
для которой необходимо настроить ограничение доступа:

```bash
php artisan egal:make:policy Post
```
В результате генерации создается файл, содержащий следующие методы ограничения доступа:
<!-- tabs:start -->

#### ** Ограничение просмотра **

|   Метод   |              Входные параметры               |                              Использование                              |
|:---------:|:--------------------------------------------:|:-----------------------------------------------------------------------:|
| showAny() |        авторизированный пользователь         |   ограничение доступа до возможности просмотреть любой объект модели    |
|  show()   | авторизированный пользователь, объект модели | ограничение доступа до возможности просмотреть конкретный объект модели |

#### ** Ограничение создания **

|    Метод    |              Входные параметры               |                            Использование                            |
|:-----------:|:--------------------------------------------:|:-------------------------------------------------------------------:|
| createAny() |        авторизированный пользователь         |   ограничение доступа до возможности создать любой объект модели    |
|  create()   | авторизированный пользователь, объект модели | ограничение доступа до возможности создать конкретный объект модели |

#### ** Ограничение редактирования **

|    Метод    |              Входные параметры               |                            Использование                             |
|:-----------:|:--------------------------------------------:|:--------------------------------------------------------------------:|
| updateAny() |        авторизированный пользователь         |   ограничение доступа до возможности обновить любой объект модели    |
|  update()   | авторизированный пользователь, объект модели | ограничение доступа до возможности обновить конкретный объект модели |

#### ** Ограничение удаления **

|    Метод    |              Входные параметры               |                            Использование                            |
|:-----------:|:--------------------------------------------:|:-------------------------------------------------------------------:|
| deleteAny() |        авторизированный пользователь         |   ограничение доступа до возможности удалить любой объект модели    |
|  delete()   | авторизированный пользователь, объект модели | ограничение доступа до возможности удалить конкретный объект модели |

<!-- tabs:end -->

>Каждый метод ограничения доступа возвращает boolean значение, при закрытии доступа - false, иначе - true.

## Доступные query-параметры

При обращении к rest-endpoints возможно использование следующих query-параметров:

### Scopes

Используя методы scope (Подробнее в [документации Laravel](https://laravel.com/docs/9.x/eloquent#local-scopes)), можно
дополнять запрос к модели фильтрами, группировками, сортировками и т.д. Внутрь метода передаётся запрос, который можно дополнять. 

Определив метод scope в модели, его можно использовать с клиента, передав query параметр с ключом scope.

Передавать scope в формате: `scope = scopeName(parameterName = parateterValue, ...)`

Например, в модели определен следующий метод scope: 
```php
<?php

namespace App\Models;

...

class Post extends Model
{

    public function initializeMetadata(): ModelMetadata
    {
        ...
    }

    public function startsBefore($query, $date)
    {
        return $query->where('starts_at', '<=', Carbon::parse($date));
    }

}
```
Таким образом, можно выполнить следующий запрос:

```http request
GET posts?scope=startsBefore(date="2022-05-25")&select=id
```

### Ограничение выборки

Для запросов на получение объектов модели обязательно указание query-параметра select, содержащего список необходимых для
получения полей объектов.

>С помощью select параметра можно запрашивать не только поля текущей, но и связанной сущности.

Например, имеются модели `Post` и `Channel`:
```php
<?php

namespace App\Models;

...

class Post extends Model
{

    public function initializeMetadata(): ModelMetadata
    {
        return ModelMetadata::make(static::class)
            ->fields(
                FieldMetadata::make('title', DataType::String)
                    ->required()
                    ->validationRules(['string'])
                    ->fillable(),
                FieldMetadata::make('channel_id', DataType::Integer)
                    ->required()
                    ->validationRules(['exists:channels,id'])
                    ->fillable()
            )
            ->relations(
                RelationMetadata::make('channel', Channel::class)
            );
    }

    public function channel(): BelongsTo
    {
        return $this->belongsTo(Channel::class);
    }
}

```
```php
<?php

namespace App\Models;

...

class Channel extends Model
{

    public function initializeMetadata(): ModelMetadata
    {
        return ModelMetadata::make(static::class)
            ->fields(
                FieldMetadata::make('title', DataType::String)
                    ->required()
                    ->fillable()
            );
    }

}
```

Таким образом, можно выполнить следующий запрос:

```http request
GET posts?select=id,title,channel.title
```

### Фильтрация

Для применения фильтрации запрашиваемых объектов можно передать query-параметр с ключом filter.

Рассмотрим возможности построения фильтра на примере модели `Post`, приведенной выше:

#### Простое условие 
   `field operator value`

Например:
```http request
GET posts?select=id&filter=title eq 'Example'
```

Доступные операторы:

| Оператор | Описание                                                                                                                  | Пример в SQL                                   |
|:--------:|:--------------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------|
|   `eq`   | Ищет точное соответствие                                                                                                  | `"full_name"="Иванов Иван Иванович"`           |
|   `eqi`  | Ищет точное соответствие (регистро-независимый режим)                                                                     | `"full_name" ILIKE "иванов иван иванович"`     |
|   `ne`   | Возвращает строки, которые не равны значению                                                                              | `"full_name"!="Иванов Иван Иванович"`          |
|   `nei`  | Возвращает строки, которые не равны значению (регистро-независимый режим)                                                 | `"full_name" NOT ILIKE "иванов иван иванович"` |
|   `gt`   | Возвращает строки, в которых значение поля больше значению аргумента (см. правила сравнения типов данных в бд)            | `"price" > 1000`                               |
|   `lt`   | Возвращает строки, в которых значение поля меньше значению аргумента                                                      | `"price" < 1000`                               |
|   `ge`   | Возвращает строки, в которых значение поля больше или равно значению аргумента                                            | `"price" >= 1000`                              | 
|   `le`   | Возвращает строки, в которых значение поля меньше или равно значению аргумента                                            | `"price" <= 1000`                              |
|   `co`   | Возвращает строки, в которых значение поля содержит частичное соответствие искомой строки                                 | `"full_name" LIKE "%Иван%"`                    |
|   `coi`  | Возвращает строки, в которых значение поля содержит частичное соответствие искомой строки (регистро-независимый режим)    | `"full_name" ILIKE "%Иван%"`                   |
|   `nc`   | Возвращает строки, в которых значение поля не содержит частичное соответствие искомой строки                              | `"full_name" NOT LIKE "%Иван%"`                |
|   `nci`  | Возвращает строки, в которых значение поля не содержит частичное соответствие искомой строки (регистро-независимый режим) | `"full_name" NOT ILIKE "%Иван%"`               |
|   `sw`   | Возвращает строки, в которых значение поля начинается с искомой строки                                                    | `"full_name" LIKE "Иван%"`                     |
|   `swi`  | Возвращает строки, в которых значение поля начинается с искомой строки (регистро-независимый режим)                       | `"full_name" ILIKE "Иван%"`                    |
|   `ew`   | Возвращает строки, в которых значение поля оканчивается искомой строкой                                                   | `"full_name" LIKE "%Иван"`                     |
|   `ewi`  | Возвращает строки, в которых значение поля оканчивается искомой строкой (регистро-независимый режим)                      | `"full_name" ILIKE "%Иван"`                    |
|   `or`   | Оператор логическое ИЛИ. Используется для составления более сложных условий                                               | `"price" > 1000 OR "price" < 2000`             | 
|   `and`  | Оператор логическое И. Используется для составления более сложных условий                                                 | `"price" > 1000 AND "price" < 2000`            |


#### Использование combiner
   `field1 operator1 value1 combiner field2 operator2 value2`

Например:
```http request
GET posts?select=id&filter=title eq 'Example' and channel_id lt 25
```

Доступные combiner:
* and
* or

#### Группировка условий
   `field1 operator1 value1 combiner (field2 operator2 value2 combiner field3 operator3 value3)`

Например:
```http request
GET posts?select=id&filter=title eq 'Example' or (channel_id lt 25 and title eq 'Another')
```

>`field` может быть как полем текущей, так и связанной сущности (в том числе для полиморфных отношений).

### Сортировка

Для применения сортировки запрашиваемых объектов можно передать query-параметр с ключом order.

В качестве значения передается направление сортировки и поле для сортировки. 

Доступные направления сортировки:
* asc
* desc

Например, для сортировки объектов модели `Post`, приведенной выше, по заголовкам постов можно выполнить запрос:
```http request
GET posts?select=id&order=asc(title)
```

### Пагинация

При обращении к index endpoint в ответе содержатся параметры пагинации: 
* Текущая страница (`current_page`), 
* Общее число объектов (`total_count`), 
* Число объектов на странице (`per_page`).

При отправке запроса на получение списка объектов можно указать query параметры с ключами `per_page` и `page`.
В качестве значений передаются число элементов на странице и номер страницы.

Например:
```http request
GET posts?select=id&per_page=30&page=3
```