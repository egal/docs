# Авторизация

### Теория:

Авторизация основана на технологии
[сетевого протокола аунтификации Kerberos](https://ru.wikipedia.org/wiki/Kerberos)
с JWT видом представления токенов.


#### Условно токены можно разделить на два типа:

* Мастер токен;
* Сервис токен.


#### Можно выделить 2 вида взаимодействия

* Пользователь — сервис;
* Сервис — сервис.


#### Соответственно для каждого из этих видов существуют следующие токены:

##### 1. Пользовательский мастер токен (UMT)

* Выпускается в сервисе авторизации методом входа.
* Используется для получения UST в сервисе авторизации.
* Хранит в себе идентификатор пользователя.
* Ключём подписи JWT является секретный ключ сервиса авторизации.
* Имеет время жизни N сек. с момента создания.

##### 2. Пользовательский токен обновления мастер токена (UMRT)

* Выпускается в сервисе авторизации методом входа.
* Используется для обновления UMT в сервисе авторизации.
* Хранит в себе идентификатор пользователя.
* Ключём подписи JWT является секретный ключ сервиса авторизации.
* Имеет время жизни N сек. с момента создания.


##### 3. Пользовательский сервис токен (UST)

* Выпускается в сервисе авторизации методом входа в сервис.
* Используется для авторизации в сервисе, для которого он был создан.
* Хранит в себе информацию о пользователе.
* Ключём подписи JWT является секретный ключ сервиса для которого он
  выпущен.
* Имеет время жизни N сек. с момента создания.

##### 4. Сервисный мастер токен (SMT)

* Выпускается в сервисе авторизации методом входа.
* Используется для получения SST в сервисе авторизации.
* Хранит в себе идентификатор сервиса.
* Ключём подписи JWT является секретный ключ сервиса авторизации.
* Имеет время жизни N сек. с момента создания.

##### 5. Сервисный сервис токен (SST)

* Выпускается в сервисе авторизации методом входа в сервис.
* Используется для авторизации в сервисе, для которого он был создан.
* Хранит в себе информацию о сервисе.
* Ключём подписи JWT является секретный ключ сервиса для которого он
  выпущен.
* Имеет время жизни N сек. с момента создания.

#### Как выполнить действие с авторизацией (см. [пример](/getting_started/step_by_step.md#_3-Авторизация)):

1. Получить `user master token` с помощью действия входа (сервиса авторизации);
2. Получить `user service token` с помощью действия входа в сервис (сервиса
   авторизации), указав `user master token` как параметр действия;
   1. Если `user master token` неактивен, можно отправить запрос на его обновление, 
   указав `user master refresh token`;
3. Отправить запрос на выполнения действия, указав `user service token` в
   качестве токена запроса действия;

> Для того чтобы клиент мог делать запросы на защищенные (UST, SST)
> endpoints вашего сервиса, этот сервис должен быть зарегистрирован в
> сервисе авторизации.

### Практика:

#### Управление доступом

Смотри [документацию](/server/access_control.md).

#### Регистрация сервисов в сервисе авторизации

1. Сгенерируйте ключ

```bash
php artisan egal:key:generate --show
```

2. Полученный ключ сохраните в переменную окружения `APP_SERVICE_KEY`
   сервиса, который будете регистрировать.
3. В переменной окружения `APP_SERVICES` сервиса авторизации перечислите 
   все сервисы и их ключи в формате: `service_1:service_1,service_2:service_2`


#### Время жизни токенов (TTL)

Для каждого вида токена можно задать время жизни следующими переменными
окружения (значение означает время в секундах):
* UMT:  `AUTH_USER_MASTER_TOKEN_TTL`;
* UMRT: `AUTH_USER_MASTER_REFRESH_TOKEN_TTL`;
* UST:  `AUTH_USER_SERVICE_TOKEN_TTL`;
* SMT:  `AUTH_SERVICE_MASTER_TOKEN_TTL`;
* SST:  `AUTH_SERVICE_SERVICE_TOKEN_TTL`.

