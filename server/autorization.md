# Авторизация

## Как это работает

### Теория:

Авторизация основана на технологии [сетевого протокола аутентификации Kerberos](https://ru.wikipedia.org/wiki/Kerberos) с JWT видом представления токенов.

##### Существуют два типа токенов:
* Пользовательский мастер токен;
* Пользовательский сервис токен;

##### Пользовательский мастер токен (UMT):
* Выпускается в сервисе авторизации методом входа;
* Используется для получения UST в сервисе авторизации;
* Хранит в себе идентификатор пользователя;
* Ключом подписи JWT является секретный ключ сервиса авторизации;
* Имеет время жизни N сек. с момента создания;

##### Пользовательский сервис токен (UST):
* Выпускается в сервисе авторизации методом входа в сервис;
* Используется для авторизации в сервисе, для которого он был создан;
* Хранит в себе информацию о пользователе;
* Ключом подписи JWT является секретный ключ сервиса для которого он выпущен;
* Имеет время жизни N сек. с момента создания;

##### Как выполнить действие с авторизацией:
1. Получить UMT с помощью действия входа (сервиса авторизации);
2. Получить UST с помощью действия входа в сервис (сервиса авторизации), указав UMT как параметр действия;
3. Отправить запрос на выполнения действия, указав UST в качестве токена запроса действия;

> Для того чтобы клиент мог делать запросы на защищенные (UST) эндпоинты сервиса, этот сервис должен быть зарегистрирован в сервисе авторизации.

### Практика:

#### Разграничение доступа

Смотри [документацию](/server/access_control.md).


#### Регистрация сервисов в сервисе авторизации

1. Сгенерируйте ключ:
```bash
php artisan egal:key:generate --show
```

2. Полученный ключ сохраните в переменную окружения `SERVICE_KEY` сервиса, который будете регистрировать;
3. Создайте экземпляр сущности `Service` в сервисе авторизации (это можно сделать в Seeder или в миграции) со следующими атрибутами:
   * id - serviceName - строковый идентификатор сервиса (к примеру 'orders')
   * name - Название сервиса для отображения
   * key - Сгенерированный ключ подписи
4. Перезапустите демона сервиса который регистрируете;


#### TTL у токенов
* UMT: 
Для изменения, нужно определить переменную окружения `AUTH_USER_MASTER_TOKEN_TTL` в секундах.
* UST:
Для изменения, нужно определить переменную окружения `AUTH_USER_SERVICE_TOKEN_TTL` в секундах.

