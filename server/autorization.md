# Авторизация

## Как это работает

### Теория:

Авторизация основана на технологии [сетевого протокола аунтификации Kerberos](https://ru.wikipedia.org/wiki/Kerberos) с JWT видом представления токенов.

##### Условно токены можно разделить на два типа:
* Мастер токен;
* Сервис токен.

##### Можно выделить 2 вида взаимодействия
* Пользователь - сервис;
* Сервис - сервис.

##### Соответственно для каждого из этих видов существуют следующие токены:

###### 1. Пользовательский мастер токен (UMT)
* Выпускается в сервисе авторизации методом входа.
* Используется для получения UST в сервисе авторизации.
* Хранит в себе идентификатор пользователя.
* Ключём подписи JWT является секретный ключ сервиса авторизации.
* Имеет время жизни N сек. с момента создания.

###### 2. Пользовательский сервис токен (UST)
* Выпускается в сервисе авторизации методом входа в сервис.
* Используется для авторизации в сервисе, для которого он был создан.
* Хранит в себе информацию о пользователе.
* Ключём подписи JWT является секретный ключ сервиса для которого он выпущен.
* Имеет время жизни N сек. с момента создания.

###### 3. Сервисный мастер токен (SMT)
* Выпускается в сервисе авторизации методом входа.
* Используется для получения SST в сервисе авторизации.
* Хранит в себе идентификатор сервиса.
* Ключём подписи JWT является секретный ключ сервиса авторизации.
* Имеет время жизни N сек. с момента создания.

###### 4. Сервисный сервис токен (SST)
* Выпускается в сервисе авторизации методом входа в сервис.
* Используется для авторизации в сервисе, для которого он был создан.
* Хранит в себе информацию о сервисе.
* Ключём подписи JWT является секретный ключ сервиса для которого он выпущен.
* Имеет время жизни N сек. с момента создания.

##### Как выполнить действие с авторизацией:
1. Получить master token с помощью действия входа (сервиса авторизации);
2. Получить service token с помощью действия входа в сервис (сервиса авторизации), указав master token как параметр действия;
3. Отправить запрос на выполнения действия, указав service token в качестве токена запроса действия;

> Для того чтобы клиент мог делать запросы на защищенные (UST, SST) эндпоинты вашего сервиса, этот сервис должен быть зарегистрирован в сервисе авторизации.

### Практика:

#### Разграничение доступа

Смотри [документацию](/server/access_control.md).


#### Регистрация сервисов в сервисе авторизации

1. Сгенерируйте ключ
```bash
php artisan egal:key:generate --show
```

2. Полученный ключ сохраните в переменную окружения `SERVICE_KEY` сервиса, который будете регистрировать.
3. Зарегистрируйте сервис. Это можно сделать следующей командой в сервисе авторизации `egal:register:service`. 
   Либо можно создать экземпляр сущности `Service` в сервисе авторизации (это можно сделать в Seeder или в миграции) со следующими атрибутами:
   * id - serviceName - строковый идентификатор сервиса (к примеру 'orders');
   * name - Название сервиса для отображения;
   * key - Сгенерированный ключ подписи.
4. Перезапустите демона сервиса который регистрируете.


#### Время жизни токенов (TTL)
Для каждого вида токена можно задать время жизни следующими переменными окружения (значение означает время в секундах):
* UMT: `AUTH_USER_MASTER_TOKEN_TTL`;
* UST: `AUTH_USER_SERVICE_TOKEN_TTL`;
* SMT: `AUTH_SERVICE_MASTER_TOKEN_TTL`;
* SST: `AUTH_SERVICE_SERVICE_TOKEN_TTL`.
