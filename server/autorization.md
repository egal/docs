# Авторизация

## Теория:

Авторизация основана на технологии [сетевого протокола аунтификации Kerberos](https://ru.wikipedia.org/wiki/Kerberos) с JWT видом представления токенов.

### Есть два типа токенов:
* Пользовательский мастер токен;
* Пользовательский сервис токен;

### Пользовательский мастер токен (UMT)
* Выпускается в сервисе авторизации методом входа.
* Используется для получения UST в сервисе авторизации.
* Хранит в себе идентификатор пользователя.
* Ключём подписи JWT является секретный ключ сервиса авторизации.
* Имеет время жизни N сек. с момента создания.

### Пользовательский сервис токен (UST)
* Выпускается в сервисе авторизации методом входа в сервис.
* Используется для авторизации в сервисе, для которого он был создан.
* Хранит в себе информацию о пользователе.
* Ключём подписи JWT является секретный ключ сервиса для которого он выпущен.
* Имеет время жизни N сек. с момента создания.

### Как выполнить действие с авторизацией:
1. Получить UMT с помощью действия входа (сервиса авторизации);
2. Получить UST с помощью действия входа в сервис (сервиса авторизации), указав UMT как параметр действия;
3. Отправить запрос на выполнения действия, указав UST в качестве токена запроса действия;

> Чтобы клиент мог делать запросы на защищенные (UST) эндпоинты вашего сервиса, этот сервис должен быть зарегистрирован в сервисе авторизации.

## Практика:

### Управление доступом

Смотри [документацию](/server/access_control.md).


#### Регистрация сервисов в сервисе авторизации

1. Сгенерируйте ключ
```bash
php artisan egal:key:generate --show
```

2. Сохраните полученный ключ в переменную окружения `SERVICE_KEY` сервиса, который будете регистрировать
3. Зарегистрируйте сервис. Это можно сделать следующей командой в сервисе авторизации `egal:register:service`. 
Либо можно создать экземпляр сущности `Service` в сервисе авторизации (это можно сделать в Seeder или в миграции) со следующими атрибутами:
   * id - serviceName - строковый идентификатор сервиса (к примеру 'orders')
   * name - Название сервиса для отображения
   * key - Сгенерированный ключ подписи
4. Перезапустите демона регистрируемого сервиса


#### TTL у токенов
* UMT: 
Для изменения нужно определить переменную окружения `AUTH_USER_MASTER_TOKEN_TTL` в секундах.
* UST:
Для изменения нужно определить переменную окружения `AUTH_USER_SERVICE_TOKEN_TTL` в секундах.

