# Task Scheduling

## Вступление

Так как Egal Server PHP основан на Laravel присутствует функционал
[Laravel Task Scheduling](https://laravel.com/docs/8.x/scheduling).

## Конфигурирование

Смотри
[официальную документацию Laravel](https://laravel.com/docs/8.x/scheduling).

## Запуск

Добавьте в `Dockerfile` сервиса, в котором необходимо запускать
планировщик следующий блок:

```dockerfile
RUN apt-get update && apt-get install -y \
    cron \
    sudo

RUN echo "* * * * * /usr/local/bin/php /app/artisan schedule:run >> /app/storage/logs/cron.log 2>&1" > /etc/cron.d/app

RUN chmod 0644 /etc/cron.d/app && \
    crontab -u $user /etc/cron.d/app && \
    adduser $user sudo && \
    echo '%sudo ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

CMD sudo cron
```

Блок с установкой `cron` и `sudo` можно не использовать, если данные
утилиты установлены в вашем контейнере ранее. Или может быть объединён с
другим блоком, в котором устанавливаются утилиты.

Блок записи задачи `cron` в файл, можно расширить своими задачами, либо
заменить на блок `COPY`, который будет копировать файл `cron` задач из
вашего проекта.

Блок `CMD` не является задачей-демоном, он должен быть дополнен. В
противном случае контейнер будет останавливаться сразу после запуска без
ошибок выполнения.

> Контейнер можно запустить только как демона обработчика Cron задач без
> запуска самого сервиса. Для реализации используйте следующий блок
> `CMD`:
>
> ```dockerfile
> CMD sudo cron -f
> ```

Блок `CMD` должен быть объединён с вашим текущим с блоком `CMD`. В
противном случае ваш `Dockerfile` не будет иметь корректный синтаксис
или же ваш контейнер будет выполнять только задачи Cron, без запуска
самого приложения.

